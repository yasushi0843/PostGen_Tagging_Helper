# PostGen_Tagging_Helper
Stable Diffusionなどの画像生成AIで生成した画像をXnView MPで閲覧する際に、画像生成後に画像生成した画像をwd14-taggerなどでタグ付けして、そのタグをXnView MPのカテゴリーにインポートするためにヘルパーユーティリティです。  
また、XnView MPは元々の機能としてStable Diffusionの生成プロンプトを見ることができますが、本スクリプトではPNGファイルからプロンプト情報を読み取ってXnView MPのカテゴリーに変換する機能も備えています。  
また、スクリプト実行時にこれらとは別の独自のカテゴリーを指定することも可能です。
# 機能
- 指定フォルダ内のPNG画像チャンクの「parameters」からStable Diffusionのプロンプトを読み取り、XnView MPのカテゴリ情報インポート用のXMLファイルを生成する（ネガティブプロンプトやその他の関連情報は読み取りません）。
- stable-diffusion-webui-wd14-taggerで生成したタグファイル（.txt）からタグを読み取り、XnView MPのカテゴリ情報インポート用のXMLファイルを生成する。
- スクリプト実行時に別途指定したカテゴリー名を前述の2つとは別にXMLファイルに追加することができる。
- 画像のフォルダは単一フォルダか、または画像フォルダの親フォルダを指定（-sオプション）することができる。
- 親フォルダを指定した場合は、フォルダ名の前方一致と後方一致によって画像フォルダをフィルタリングすることができる。指定したプレフィックスとサフィックスを含むもしくは含まないの2通りの指定が可能。
- PNGファイルの更新日時によって対象PNGファイルをフィルタリングすることができる。
- taggerで生成したtxtファイルの更新日時によって対応するPNGファイルをフィルタリングすることができる。
# インストール
以下の手順はWindowsでpythonとgitが事前にインストールされている環境をを想定しています。  
本ツールのインストール用のフォルダを作成して、そのフォルダの中でターミナルを開いて以下のコマンドを実行してください。ターミナルはエクスプローラで作成したフォルダへ行き、右クリックをするとコンテキストメニューの中から開くことができます。
```
git clone https://github.com/yasushi0843/PostGen_Tagging_Helper.git
cd PostGen_Tagging_Helper
pip install -r requirements.txt
```
venv環境を作成してのインストールは以下の通りです
```
git clone https://github.com/yasushi0843/PostGen_Tagging_Helper.git
python -m venv venv
.\venv\Scripts\activate
cd PostGen_Tagging_Helper
pip install -r requirements.txt
```
venv環境を作成した場合は作成したvenv環境を有効にしてから本スクリプトを実行する必要があります。venvを有効にするには、本ツールのインストール用のフォルダで`.\venv\Scripts\activate`を実行してvenv環境を有効にしてから本スクリプトを実行してください。
# 実行方法
wd14-taggerなどでタグ付けをしたタグをXnView MPにインポートする場合は、先にタグファイルを作成してください。タグファイルはPNGファイルと同名で拡張子は「.txt」である必要があります。  
例えば「D:\images」フォルダに画像ファイルがある場合の実行例は以下の通りです。デフォルトでは「XnView_Catalog.xml」というxmlファイルがスクリプトを実行したフォルダに作成されます。
```
python pgth.py "D:\images" -p -t
```
「D:\images」フォルダのサブフォルダとして複数の画像フォルダがある場合の実行例は以下の通りです。
```
python pgth.py "D:\images" -s -p -t
```
`-p`（プロンプトを解析）か`-t`（タグファイルを解析）か`-c`（カテゴリーの手動指定）の中から最低でも1つ以上のオプションの指定が必須となります。画像フォルダの指定も必須です。  
XnView MPへのインポート後、プロンプトは「prompts」カテゴリーのサブカテゴリに割り振られ、taggerで生成したタグは「tags」カテゴリーのサブカテゴリーに割り当てられます。（「prompts」と「tags」というカテゴリー名は固定となります）  
フィルタリングについては、例えば画像フォルダ名が「ab」で始まるフォルダのみを対象としたい場合は以下の通りです。
```
python pgth.py "D:\images" -s -p -t -pf ab
```
「yz」で終わるフォルダのみを除外したい場合は以下の通りです。
```
python pgth.py "D:\images" -s -p -t -exsf yz
```
過去3日間に更新されたPNGファイルを対象とする場合は以下の通りです。
```
python pgth.py "D:\images" -s -p -t -da 3
```
更新日が10日前よりも古いタグファイルと同名のPNGファイルを対象とする場合は以下の通りです。
```
python pgth.py "D:\images" -s -p -t -tdb 10
```
作成されたxmlファイル（デフォルトでは「XnView_Catalog.xml」）は、XnView MPのカテゴリパネルの右上のメニューの「ファイルのカテゴリー」⇒「インポート」からXnView MPへインポートできます。
# オプション
- `-p` Stable DiffusionがPNGファイルに埋め込んだプロンプトを解析します。
- `-t` タグファイル（tagger等で生成されたPNGファイルと同名のtxtファイル）を解析します。
- `-c` スクリプト実行時にカテゴリーを指定できます（複数指定可）。指定したカテゴリーがスクリプトで抽出された全てのPNGファイルにカテゴリーとして割り当てられます。カテゴリーを階層化する場合は`|`を間に挟んでください（`"`で囲む必要あり）例：`-c "cat_p|cat_c"`
- `-s` 指定フォルダのサブフォルダに画像ファイルがあると見なして動作します。このオプションを指定しない場合は、指定フォルダの直下に画像ファイルがあると見なします。
- `-o` 出力されるXMLファイルのファイル名を指定できます。何も指定しない場合は「XnView_Catalog.xml」というファイルが出力されます。
- `-pf` 指定した文字列から始まる画像フォルダのみを対象とします。（`-s`オプションを使用した場合のみ有効）
- `-sf` 指定した文字列で終わる画像フォルダのみを対象とします。（`-s`オプションを使用した場合のみ有効）
- `-expf` 指定した文字列から始まる画像フォルダが対象から除外されます。（`-s`オプションを使用した場合のみ有効）
- `-exsf` 指定した文字列で終わる画像フォルダが対象から除外されます。（`-s`オプションを使用した場合のみ有効）
- `-da` 更新日時が指定した日数よりも新しいPNGファイルが対象となります（少数指定可能）。カレンダー上の日付ではなく実際の経過時間（例えば「1」の場合は24時間前）で計算されます。（`-s`オプションを使用した場合のみ有効）
- `-db` 更新日時が指定した日数よりも古いPNGファイルが対象となります。（`-s`オプションを使用した場合のみ有効）
- `-tda` PNGファイルと同名のタグファイル（txtファイル）の更新日時が指定した日数よりも新しいPNGファイルが対象となります。（`-s`オプションを使用した場合のみ有効）
- `-tdb` PNGファイルと同名のタグファイル（txtファイル）の更新日時が指定した日数よりも古いPNGファイルが対象となります。（`-s`オプションを使用した場合のみ有効）
- `-n` 解析はしますがXMLファイルは出力しません（つまりdryrunです）。
- `-v` 冗長出力をします。このオプションでフォルダ、PNGファイル、タグ（txt）ファイルの更新日時が何日前かを出力してくれるので、日時フィルタリングの予備調査に使用できます。出力を後から見たい場合は` > output.txt`などを実行コマンドの最後に付け加えると良いです。
# 特記事項
- フィルタリング用のオプションを複数指定した場合はAND検索となります。つまり全ての条件を満たすものが対象となります。
- XnView MPのインポート動作は既にカテゴリ登録された画像には影響しないようですので未登録の画像ファイルをフィルターオプションで絞り込んでXMLファイルを作成するのが良いかと思います。
# ベータ版
`pgth_v011beta.py`はあまりテストしていないベータ版です。`-sr [数字]`オプションを付けることにより、指定フォルダのサブフォルダをこのオプションで指定した数字の分だけ下階層までサーチします。`-sr 1`は`-s`と同じ意味となります。ベータ版なのでちゃんと動かなかったらごめんなさい。  
ちなみに細かいことですが、ベータ版の方はコードを変更した影響で`-s`や`-sr`をつけなくてもフィルタ系のオプションの効果は発揮されます。実質的な影響はないでしょうが。
# おまけ
PNGファイルにメモを追加するスクリプトです。ちょっと面倒ですが準備方法は以下の通りです。
1. `python memo.py -l`コマンドを実行するとWindowsのショートカットの「リンク先」として設定すべき文字列を出力してくれますので、その文字列をコピペしてWindowsのショートカットを作成してください。
2. PNGファイルをショートカットにドラッグアンドドロップするとターミナルが自動で立ち上がるので、メモを打ち込んでEnterキーを押してください。  

これでPNGのメタ情報にメモが追加されます。このメモはXnView MPでStable Diffusionが埋め込むプロンプトと一緒に見ることができます。なぜかUTF-8にしても文字化けするので英語しか使えませんが。。  
ファイル壊れるといけないので、念のため大事ではないPNGで試してから使ってください。  
なお、画像ファイルのパスに含まれるスペースや特殊記号によっては動作しないことがあります。（連続しない半角スペースだけならば動作するはずです）
